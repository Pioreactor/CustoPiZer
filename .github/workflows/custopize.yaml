name: "CustoPiZe"

on:
  repository_dispatch:
    types: pioreactor_release
  workflow_dispatch:
    inputs:
      pioreactor_version:
        description: "Pioreactor version"
        required: true
        default: ''

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    steps:

    - name: "⬇ Checkout"
      uses: actions/checkout@v2

    - name: "🔎 Determine Pioreactor version"
      run: |
        if [[ "${{ github.event_name }}" = "repository_dispatch" && "${{ github.event.action }}" = "pioreactor_release" ]]; then
          PIOREACTOR_VERSION="${{ github.event.client_payload.version }}"
          echo "Version from repository dispatch: $PIOREACTOR_VERSION"
        else
          PIOREACTOR_VERSION="${{ github.event.inputs.pioreactor_version }}"
          echo "Version from workflow dispatch: $PIOREACTOR_VERSION"
        fi
        echo "PIOREACTOR_VERSION=$PIOREACTOR_VERSION" >> $GITHUB_ENV
    - name: "⬇ Download RPi image"
      id: download_rpi_image
      run: |
        mkdir -p build
        cd build
        wget https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2022-09-26/2022-09-22-raspios-bullseye-armhf-lite.img.xz -q -O input.img.xz
        unxz -f input.img.xz
    - name: "📝 Prepare release"
      run: |
        now=$(date +"%Y%m%d%H%M%S")
        RELEASE_NAME="Pioreactor ${{ env.PIOREACTOR_VERSION }} (build $now)"
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
        RELEASE_TAG="${{ env.PIOREACTOR_VERSION }}"
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        
        # release body
        cat <<EOF > ./build/release.md
  
          * Pioreactor ${{ env.PIOREACTOR_VERSION }}

        Created with [CustoPiZer](https://github.com/Pioreactor/CustoPiZer)
        Includes *experimental* leader-worker 64-bit image.

        <!-- mark:untested -->
        EOF



    - name: "🏗 Run CustoPiZer LW"
      uses: Pioreactor/CustoPiZer@pioreactor
      with:
        workspace: "${{ github.workspace }}/build"
        scripts:  "${{ github.workspace }}/workspace/scripts"
        config: "${{ github.workspace }}/config.local"
        environment: '{ "PIO_VERSION": "${{ env.PIOREACTOR_VERSION }}", "LEADER": 1, "WORKER": 1 }'
    
    - name: "✏ Rename image LW"
      run: |
        IMAGE_LEADER_WORKER="pioreactor_leader_worker.img"
        echo "IMAGE_LEADER_WORKER=$IMAGE_LEADER_WORKER" >> $GITHUB_ENV
        cd build
        mv output.img $IMAGE_LEADER_WORKER

    - name: "📦 Package the image LW"
      id: package-image-lw
      uses: OctoPrint/actions/package-rpi-image@main
      with:
        image_path: "build/${{ env.IMAGE_LEADER_WORKER }}"

    - name: 📨 Export zip name to env LW
      run: |
        IMAGE_LEADER_WORKER_URL=https://github.com/Pioreactor/CustoPiZer/releases/download/${{ env.RELEASE_TAG }}/${{ steps.package-image-lw.outputs.zip_name }}
        echo "IMAGE_LEADER_WORKER_ZIP=${{ steps.package-image-lw.outputs.zip_name }}" >> $GITHUB_ENV
        echo "IMAGE_LEADER_WORKER_URL=$IMAGE_LEADER_WORKER_URL" >> $GITHUB_ENV
        echo "Link to leader image: $IMAGE_LEADER_WORKER_URL" >> $GITHUB_STEP_SUMMARY



    - name: "🏗 Run CustoPiZer W"
      uses: Pioreactor/CustoPiZer@pioreactor
      with:
        workspace: "${{ github.workspace }}/build"
        scripts:  "${{ github.workspace }}/workspace/scripts"
        config: "${{ github.workspace }}/config.local"
        environment: '{ "PIO_VERSION": "${{ env.PIOREACTOR_VERSION }}", "LEADER": 0, "WORKER": 1 }'

    - name: "✏ Rename image W"
      run: |
        IMAGE_WORKER="pioreactor_worker.img"
        echo "IMAGE_WORKER=$IMAGE_WORKER" >> $GITHUB_ENV
        cd build
        mv output.img $IMAGE_WORKER

    - name: "📦 Package the image W"
      id: package-image-w
      uses: OctoPrint/actions/package-rpi-image@main
      with:
        image_path: "build/${{ env.IMAGE_WORKER }}"

    - name: 📨 Export zip name to env W
      run: |
        echo "IMAGE_WORKER_ZIP=${{ steps.package-image-w.outputs.zip_name }}" >> $GITHUB_ENV
        echo "IMAGE_WORKER_URL=https://github.com/Pioreactor/CustoPiZer/releases/download/${{ env.RELEASE_TAG }}/${{ steps.package-image-w.outputs.zip_name }}" >> $GITHUB_ENV



    - name: "⬇ Download RPi 64-bit image"
      id: download_rpi_image_64
      run: |
        mkdir -p build
        cd build
        wget https://downloads.raspberrypi.org/raspios_lite_arm64/images/raspios_lite_arm64-2022-09-26/2022-09-22-raspios-bullseye-arm64-lite.img.xz -q -O input.img.xz
        unxz -f input.img.xz

    - name: "🏗 Run CustoPiZer LW 64"
      uses: Pioreactor/CustoPiZer@pioreactor
      with:
        workspace: "${{ github.workspace }}/build"
        scripts:  "${{ github.workspace }}/workspace/scripts"
        config: "${{ github.workspace }}/config_64.local"
        environment: '{ "PIO_VERSION": "${{ env.PIOREACTOR_VERSION }}", "LEADER": 1, "WORKER": 1 }'

    - name: "✏ Rename image LW 64"
      run: |
        IMAGE_LEADER_WORKER_64="pioreactor_leader_worker_64.img"
        echo "IMAGE_LEADER_WORKER_64=$IMAGE_LEADER_WORKER_64" >> $GITHUB_ENV
        cd build
        mv output.img $IMAGE_LEADER_WORKER_64

    - name: "📦 Package the image LW 64"
      id: package-image-lw-64
      uses: OctoPrint/actions/package-rpi-image@main
      with:
        image_path: "build/${{ env.IMAGE_LEADER_WORKER_64 }}"

    - name: 📨 Export zip name to env LW 64
      run: |
        IMAGE_LEADER_WORKER_64_URL=https://github.com/Pioreactor/CustoPiZer/releases/download/${{ env.RELEASE_TAG }}/${{ steps.package-image-lw-64.outputs.zip_name }}
        echo "IMAGE_LEADER_WORKER_64_ZIP=${{ steps.package-image-lw-64.outputs.zip_name }}" >> $GITHUB_ENV
        echo "IMAGE_LEADER_WORKER_64_URL=$IMAGE_LEADER_WORKER_64_URL" >> $GITHUB_ENV
        echo "Link to leader 64bit image: $IMAGE_LEADER_WORKER_64_URL" >> $GITHUB_STEP_SUMMARY






    - name: "🔖 Create release & attach assets"
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'repository_dispatch'
      with:
        name: "${{ env.RELEASE_NAME }}"
        tag_name: "${{ env.RELEASE_TAG }}"
        body_path: "build/release.md"
        prerelease: ${{ contains(env.PIOREACTOR_VERSION, 'rc') }}
        fail_on_unmatched_files: true
        files: |
          build/${{ env.IMAGE_LEADER_WORKER_ZIP }}
          build/${{ env.IMAGE_LEADER_WORKER_ZIP }}.md5
          build/${{ env.IMAGE_LEADER_WORKER_ZIP }}.sha256
          build/${{ env.IMAGE_LEADER_WORKER_64_ZIP }}
          build/${{ env.IMAGE_LEADER_WORKER_64_ZIP }}.md5
          build/${{ env.IMAGE_LEADER_WORKER_64_ZIP }}.sha256
          build/${{ env.IMAGE_WORKER_ZIP }}
          build/${{ env.IMAGE_WORKER_ZIP }}.md5
          build/${{ env.IMAGE_WORKER_ZIP }}.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}